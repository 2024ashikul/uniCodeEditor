FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV CODE_SERVER_VERSION=4.23.0
ARG TARGETARCH

# Install basic dependencies
RUN apt-get update && apt-get install -y curl sudo gosu

# --- THIS IS THE MISSING STEP ---
# Download and install the correct version of code-server
RUN curl -fsSL "https://github.com/coder/code-server/releases/download/v${CODE_SERVER_VERSION}/code-server-${CODE_SERVER_VERSION}-linux-${TARGETARCH}.tar.gz" \
  | tar -xz -C /opt && \
  ln -s /opt/code-server-*/bin/code-server /usr/local/bin/code-server

COPY entrypoint.lab.sh /
RUN chmod +x /entrypoint.lab.sh

EXPOSE 8080
ENTRYPOINT ["/entrypoint.lab.sh"]